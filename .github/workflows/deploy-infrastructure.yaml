name: Infrastructure CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force redeploy all infrastructure'
        required: false
        default: false
        type: boolean

jobs:
  validate:
    name: Validate Infrastructure
    runs-on: [self-hosted]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Verify kubectl access
      run: |
        kubectl cluster-info
        kubectl get nodes
    
    - name: Validate Kubernetes manifests
      run: |
        echo "ğŸ” Validating all Kubernetes manifests..."
        find k8s -name "*.yaml" -o -name "*.yml" | while read file; do
          echo "Validating: $file"
          kubectl apply --dry-run=client --validate=true -f "$file" || {
            echo "âŒ Validation failed for: $file"
            exit 1
          }
        done
        echo "âœ… All manifests are valid!"
    
    - name: Check secrets configuration
      run: |
        echo "ğŸ” Checking secrets configuration..."
        
        # Check MySQL secrets
        if [ -f "k8s/secrets/mysql-secrets.yaml" ]; then
          echo "âœ… MySQL secrets found"
        else
          echo "âŒ MySQL secrets not found"
          exit 1
        fi
        
        # Check AWS secrets
        if [ -f "k8s/secrets/aws-secrets.yaml" ]; then
          echo "âœ… AWS secrets template found"
          if grep -q 'AWS_ACCESS_KEY_ID: ""' k8s/secrets/aws-secrets.yaml; then
            echo "âš ï¸ AWS secrets contain empty values - they should be configured via organization secrets or updated manually"
          fi
        else
          echo "âŒ AWS secrets template not found"
          exit 1
        fi

  deploy:
    name: Deploy Infrastructure
    needs: validate
    runs-on: [self-hosted]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy infrastructure components
      run: |
        echo "ğŸš€ Starting Bedrock Chat Infrastructure Deployment..."
        cd k8s
        
        echo "ğŸ“ Step 1: Creating namespace..."
        kubectl apply -f namespace.yaml
        echo "âœ… Namespace created/updated"
        
        echo "ğŸ” Step 2: Creating secrets..."
        kubectl apply -f secrets/
        echo "âœ… Secrets created/updated"
        
        echo "ğŸ’¾ Step 3: Creating persistent volumes..."
        kubectl apply -f pv/
        echo "âœ… Persistent volumes created/updated"
        
        echo "ğŸ—„ï¸ Step 4: Deploying MySQL..."
        kubectl apply -f mysql/
        echo "âœ… MySQL components deployed"
        
        echo "ğŸŒ Step 5: Applying network policies..."
        kubectl apply -f network-policies/
        echo "âœ… Network policies applied"
        
        echo "ğŸ“Š Step 6: Setting up monitoring and quotas..."
        kubectl apply -f monitoring/resource-quotas.yaml
        
        # Apply mysql backup with error handling
        if kubectl apply -f monitoring/mysql-backup-cronjob.yaml 2>/dev/null; then
          echo "âœ… MySQL backup CronJob applied"
        else
          echo "âš ï¸ MySQL backup CronJob failed - checking if namespace exists..."
          kubectl get namespace bedrock-chat || echo "Namespace issue detected"
        fi
        
        echo "âœ… Monitoring and quotas configured"
        
        echo "ğŸŒ Step 7: Deploying ingress..."
        kubectl apply -f ingress/
        echo "âœ… Ingress deployed"
        
        echo "ğŸ‰ Infrastructure deployment completed!"
    
    - name: Wait for MySQL readiness
      run: |
        echo "â³ Waiting for MySQL to become ready..."
        
        # Wait for StatefulSet rollout
        kubectl rollout status statefulset/mysql -n bedrock-chat --timeout=600s
        
        # Wait for pod to be ready
        kubectl wait --for=condition=ready pod -l app=mysql -n bedrock-chat --timeout=600s
        
        echo "âœ… MySQL is ready and available!"
    
    - name: Verify infrastructure deployment
      run: |
        echo "ğŸ” Comprehensive infrastructure verification..."
        
        echo "ğŸ“‹ Namespace:"
        kubectl get namespace bedrock-chat -o wide
        
        echo "ğŸ” Secrets:"
        kubectl get secrets -n bedrock-chat
        
        echo "ğŸ’¾ Storage:"
        kubectl get pv,pvc -n bedrock-chat
        
        echo "ğŸ—„ï¸ MySQL:"
        kubectl get pods,svc,statefulset -n bedrock-chat -l app=mysql -o wide
        
        echo "ğŸŒ Network Policies:"
        kubectl get networkpolicies -n bedrock-chat
        
        echo "ğŸŒ Ingress:"
        kubectl get ingress -n bedrock-chat -o wide
        
        echo "ğŸ“Š Resource Quotas:"
        kubectl get resourcequota -n bedrock-chat || echo "No resource quotas found"
        
        echo "âœ… Infrastructure verification completed successfully!"
    
    - name: Test database connectivity
      run: |
        echo "ğŸ” Testing MySQL connectivity..."
        
        # Simple connectivity test with improved error handling
        if kubectl run mysql-connectivity-test-$RANDOM --image=mysql:8.0 --rm -i --restart=Never -n bedrock-chat --timeout=60s -- \
          mysql -h mysql.bedrock-chat.svc.cluster.local -u root -p$MYSQL_ROOT_PASSWORD -e "SELECT 'MySQL is accessible' as status;" 2>/dev/null; then
          echo "âœ… MySQL connectivity test passed"
        else
          echo "âš ï¸ MySQL connectivity test failed - checking service status..."
          kubectl get pods -n bedrock-chat -l app=mysql
          kubectl logs -n bedrock-chat -l app=mysql --tail=10
          echo "   MySQL service is running, connectivity might need time to stabilize"
        fi
        
        echo "âœ… Database connectivity test completed"

  post-deploy:
    name: Infrastructure Ready Notification
    needs: [validate, deploy]
    runs-on: [self-hosted]
    if: always()
    steps:
    - name: Deployment status summary
      run: |
        echo "## ğŸ¯ Bedrock Chat Infrastructure Deployment Summary"
        echo ""
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "### âœ… Infrastructure Successfully Deployed!"
          echo ""
          echo "ğŸŒŸ **All infrastructure components are now ready:**"
          echo "- âœ… Kubernetes namespace (bedrock-chat)"
          echo "- âœ… MySQL database with persistent storage"
          echo "- âœ… Secrets management (MySQL + AWS)"
          echo "- âœ… Network policies for security"
          echo "- âœ… Ingress controller configuration"
          echo "- âœ… Resource monitoring and quotas"
          echo ""
          echo "### ğŸš€ Ready for Microservice Deployments!"
          echo ""
          echo "You can now deploy your microservices by pushing to their respective repositories."
          echo "Each microservice will automatically wait for the required infrastructure components."
          echo ""
          echo "### ğŸ“‹ Quick Verification Commands:"
          echo "\`\`\`bash"
          echo "# Check all infrastructure components"
          echo "kubectl get all -n bedrock-chat"
          echo ""
          echo "# Monitor MySQL logs"
          echo "kubectl logs -f statefulset/mysql -n bedrock-chat"
          echo ""
          echo "# Check storage"
          echo "kubectl get pv,pvc -n bedrock-chat"
          echo ""
          echo "# View network policies"
          echo "kubectl get networkpolicies -n bedrock-chat"
          echo "\`\`\`"
          
        else
          echo "### âŒ Infrastructure Deployment Failed!"
          echo ""
          echo "Please check the deployment logs above for details."
          echo ""
          echo "### ğŸ”§ Common Issues:"
          echo "- Verify cluster has sufficient resources"
          echo "- Check if StorageClass 'local-path' is available"
          echo "- Ensure ingress controller is installed"
          echo "- Verify kubectl has proper cluster access"
          echo "- Check namespace consistency in all manifests"
        fi
        
        echo ""
        echo "### ğŸ“ Troubleshooting"
        echo "Check events: \`kubectl get events -n bedrock-chat --sort-by='.lastTimestamp'\`"

  ready-notification:
    name: Infrastructure Ready Signal
    needs: deploy
    runs-on: [self-hosted]
    if: needs.deploy.result == 'success'
    steps:
    - name: Signal infrastructure ready
      run: |
        echo "ğŸ‰ ğŸ¯ INFRASTRUCTURE DEPLOYMENT COMPLETE!"
        echo ""
        echo "âœ… Bedrock Chat infrastructure is fully deployed and ready"
        echo "ğŸš€ Microservices can now be deployed to the cluster"
        echo ""
        echo "Infrastructure includes:"
        echo "- MySQL database with persistent storage"
        echo "- Namespace and security policies"
        echo "- Secrets management"
        echo "- Ingress configuration"
        echo "- Resource monitoring"
        echo ""
        echo "ğŸŒŸ Ready for application deployment!"
