name: Deploy Infrastructure (CD Only)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force redeploy all infrastructure components'
        required: false
        default: false
        type: boolean

jobs:
  validate:
    name: Validate Infrastructure Manifests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Validate all YAML manifests
      run: |
        echo "ğŸ” Validating Kubernetes manifests..."
        find k8s -name "*.yaml" -o -name "*.yml" | while read file; do
          echo "Validating: $file"
          kubectl apply --dry-run=client --validate=true -f "$file" || {
            echo "âŒ Validation failed for: $file"
            exit 1
          }
        done
        echo "âœ… All manifests are valid!"
    
    - name: Check for required secrets
      run: |
        echo "ğŸ” Checking for required configurations..."
        
        # Check if AWS secrets template exists
        if [ -f "k8s/secrets/aws-secrets.yaml" ]; then
          echo "âœ… AWS secrets template found"
          
          # Check if it contains placeholder values
          if grep -q "AWS_ACCESS_KEY_ID: \"\"" k8s/secrets/aws-secrets.yaml; then
            echo "âš ï¸  AWS secrets contain empty values - make sure to configure them before deployment"
          else
            echo "âœ… AWS secrets appear to be configured"
          fi
        else
          echo "âŒ AWS secrets template not found"
          exit 1
        fi
        
        # Check MySQL secrets
        if [ -f "k8s/secrets/mysql-secrets.yaml" ]; then
          echo "âœ… MySQL secrets template found"
        else
          echo "âŒ MySQL secrets template not found"
          exit 1
        fi

  deploy:
    name: Deploy Infrastructure
    needs: validate
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Configure kubectl
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
        chmod 600 $HOME/.kube/config
    
    - name: Verify cluster connection
      run: |
        echo "ğŸ” Verifying cluster connection..."
        kubectl cluster-info
        kubectl get nodes
        echo "âœ… Cluster connection verified!"
    
    - name: Deploy infrastructure components
      run: |
        echo "ğŸš€ Starting Bedrock Chat Infrastructure Deployment..."
        cd k8s
        
        echo "ğŸ“ Step 1: Creating namespace..."
        kubectl apply -f namespace.yaml
        echo "âœ… Namespace created/updated"
        
        echo "ğŸ” Step 2: Creating secrets..."
        kubectl apply -f secrets/
        echo "âœ… Secrets created/updated"
        
        echo "ğŸ’¾ Step 3: Creating persistent volumes..."
        kubectl apply -f pv/
        echo "âœ… Persistent volumes created/updated"
        
        echo "ğŸ—„ï¸ Step 4: Deploying MySQL..."
        kubectl apply -f mysql/
        echo "âœ… MySQL components deployed"
        
        echo "ğŸŒ Step 5: Applying network policies..."
        kubectl apply -f network-policies/
        echo "âœ… Network policies applied"
        
        echo "ğŸ“Š Step 6: Setting up monitoring and resource quotas..."
        kubectl apply -f monitoring/
        echo "âœ… Monitoring and quotas configured"
        
        echo "ğŸŒ Step 7: Deploying ingress..."
        kubectl apply -f ingress/
        echo "âœ… Ingress deployed"
        
        echo "ğŸ‰ Infrastructure deployment completed!"
    
    - name: Wait for MySQL readiness
      run: |
        echo "â³ Waiting for MySQL to become ready..."
        
        # Wait for MySQL StatefulSet to be ready
        kubectl rollout status statefulset/mysql -n bedrock-chat --timeout=600s
        
        # Wait for MySQL pod to be ready
        kubectl wait --for=condition=ready pod -l app=mysql -n bedrock-chat --timeout=600s
        
        echo "âœ… MySQL is ready!"
    
    - name: Verify infrastructure deployment
      run: |
        echo "ğŸ” Verifying infrastructure deployment..."
        
        echo "ğŸ“‹ Namespace status:"
        kubectl get namespace bedrock-chat -o wide
        
        echo "ğŸ” Secrets status:"
        kubectl get secrets -n bedrock-chat
        
        echo "ğŸ’¾ Storage status:"
        kubectl get pv,pvc -n bedrock-chat
        
        echo "ğŸ—„ï¸ MySQL status:"
        kubectl get pods,svc,statefulset -n bedrock-chat -l app=mysql -o wide
        
        echo "ğŸŒ Network policies:"
        kubectl get networkpolicies -n bedrock-chat
        
        echo "ğŸŒ Ingress status:"
        kubectl get ingress -n bedrock-chat -o wide
        
        echo "ğŸ“Š Resource quotas:"
        kubectl get resourcequota -n bedrock-chat
        
        echo "âœ… Infrastructure verification completed!"
    
    - name: Test MySQL connectivity
      run: |
        echo "ğŸ” Testing MySQL connectivity..."
        
        # Test MySQL connection from within the cluster
        kubectl run mysql-test --image=mysql:8.0 --rm -i --restart=Never -n bedrock-chat -- \
          mysql -h mysql.bedrock-chat.svc.cluster.local -u root -pSecureRootPassword123! -e "SELECT 1;" || {
          echo "âš ï¸ MySQL connectivity test failed - this might be expected if custom passwords are used"
        }
        
        echo "âœ… MySQL connectivity test completed"

  post-deploy:
    name: Post-Deployment Status
    needs: [validate, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Deployment Status Summary
      run: |
        echo "## ğŸ¯ Bedrock Chat Infrastructure Deployment Summary"
        echo ""
        echo "### ğŸ“Š Job Status"
        echo "- **Validation**: ${{ needs.validate.result }}"
        echo "- **Deployment**: ${{ needs.deploy.result }}"
        echo ""
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "### âœ… Infrastructure Successfully Deployed!"
          echo ""
          echo "Your Bedrock Chat infrastructure is now ready. You can now deploy the microservices:"
          echo ""
          echo "### ğŸš€ Next Steps:"
          echo "1. **Deploy microservices** - Push code to each microservice repository"
          echo "2. **Configure AWS secrets** - Update the aws-secrets in the cluster if needed"
          echo "3. **Verify services** - Check that all services deploy and connect properly"
          echo ""
          echo "### ğŸ“‹ Useful Commands:"
          echo "\`\`\`bash"
          echo "# Check all infrastructure components"
          echo "kubectl get all -n bedrock-chat"
          echo ""
          echo "# Monitor MySQL startup"
          echo "kubectl logs -f statefulset/mysql -n bedrock-chat"
          echo ""
          echo "# Check persistent storage"
          echo "kubectl get pv,pvc -n bedrock-chat"
          echo ""
          echo "# View ingress configuration"
          echo "kubectl get ingress -n bedrock-chat -o wide"
          echo "\`\`\`"
          echo ""
          echo "### ğŸŒŸ Infrastructure Components Ready:"
          echo "- âœ… Kubernetes namespace (bedrock-chat)"
          echo "- âœ… MySQL database with persistent storage"
          echo "- âœ… Secrets management (MySQL + AWS)"
          echo "- âœ… Network policies for security"
          echo "- âœ… Ingress for external access"
          echo "- âœ… Resource quotas and monitoring"
          echo ""
        else
          echo "### âŒ Infrastructure Deployment Failed!"
          echo ""
          echo "Please check the deployment logs above for error details."
          echo ""
          echo "### ğŸ”§ Common Issues:"
          echo "- Verify KUBECONFIG secret is correctly configured"
          echo "- Ensure cluster has sufficient resources"
          echo "- Check if StorageClass 'local-path' is available"
          echo "- Verify ingress controller is installed"
          echo ""
        fi
        
        echo "### ğŸ“ Support"
        echo "If you encounter issues, check the workflow logs and Kubernetes events:"
        echo "\`kubectl get events -n bedrock-chat --sort-by='.lastTimestamp'\`"

  notify-completion:
    name: Notify Infrastructure Ready
    needs: [deploy]
    runs-on: ubuntu-latest
    if: needs.deploy.result == 'success'
    steps:
    - name: Infrastructure Ready Notification
      run: |
        echo "ğŸ‰ ğŸ¯ BEDROCK CHAT INFRASTRUCTURE IS READY!"
        echo ""
        echo "âœ… All infrastructure components have been successfully deployed"
        echo "ğŸš€ You can now proceed to deploy your microservices"
        echo ""
        echo "The following components are now available:"
        echo "- Kubernetes namespace: bedrock-chat"
        echo "- MySQL database with persistent storage"
        echo "- Network security policies"
        echo "- Ingress configuration for external access"
        echo "- Resource monitoring and quotas"
        echo ""
        echo "Ready for microservice deployments! ğŸŒŸ"
