name: CD - Test Without MySQL

on:
  workflow_dispatch:

jobs:
  TEST-DEPLOY:
    runs-on: self-hosted
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
      
      - name: Apply Namespace
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmaps/ --recursive -n bedrock-chat-v2
          kubectl apply -f k8s/dockerhub-secrets.yaml -n bedrock-chat-v2
      
      - name: Deploy Frontend
        run: |
          kubectl apply -f k8s/services/frontend-service.yaml -n bedrock-chat-v2
          kubectl apply -f k8s/services/frontend-nodeport.yaml -n bedrock-chat-v2
          kubectl apply -f k8s/deployments/frontend-deployment.yaml -n bedrock-chat-v2
          kubectl wait --for=condition=ready pod -l app=frontend -n bedrock-chat-v2 --timeout=120s
      
      - name: Deploy Bedrock Service
        run: |
          kubectl apply -f k8s/services/bedrock-service-service.yaml -n bedrock-chat-v2
          kubectl apply -f k8s/deployments/bedrock-service-deployment.yaml -n bedrock-chat-v2
          kubectl wait --for=condition=ready pod -l app=bedrock-service -n bedrock-chat-v2 --timeout=120s
      
      - name: Show status
        run: |
          kubectl get pods -n bedrock-chat-v2
          NODE_PORT=$(kubectl get svc frontend-nodeport -n bedrock-chat-v2 -o jsonpath='{.spec.ports[0].nodePort}')
          echo "Frontend: http://YOUR-EC2-IP:$NODE_PORT"
